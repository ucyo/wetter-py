<!DOCTYPE html>
<html>
  <head>
    <title>wetter-py</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Merriweather:400);
      @import url(https://fonts.googleapis.com/css?family=JetBrains+Mono:400);
      @import url(https://fonts.googleapis.com/css?family=Montserrat:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Roboto:300,400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=PT+Mono:400,700,400italic);

      .left-column {
        width: 45%;
        float: left;
        margin-right: 10px;
      }
      .right-column {
        width: 48%;
        float: right;
      }

      body {
        font-family: 'Roboto';
        font-weight: 300;
        line-height: 1.2;
        color: #383838;
      }
      h1, h2, h3 {
        font-family: 'Merriweather';
        font-weight: normal;
      }
      .remark-slide-content h1 {
        font-size: 40px;
      }
      .remark-slide-content h2 {
        font-size: 30px;
      }
      .remark-slide-content {
        font-size: 23px;
      }
      table, td, th {
        border: 1px solid black;
      }
      td {
        padding: 10px;
      }

      .red {
        color: red;
      }
      .green {
        color: green;
      }

      .remark-code, .remark-inline-code {
        font-family: 'JetBrains Mono', monospace;
      }

      .remark-inline-code {
        background: lightgray;
        padding-left: 5pt;
        margin-bottom: 5pt;
        margin-top: 5pt;
        padding-right: 5pt;
        border-radius: 5px;
        font-size: 21px;
      }
      .remark-code-span-highlighted {
        color: cyan;
        font-weight: bold;
        background: revert;
      }
      .remark-code {
        max-height: 400px;
        border-radius: 5px;
        font-size: 16px;
      }

      .image-50 img {
        width: 50%;
      }

      .footy {
        font-size: 10px;
      }

    </style>
  </head>
  <body>
    <textarea id="source">


class: middle


# wetter-py
.image-50[![](https://raw.githubusercontent.com/ucyo/wetter-py/master/assets/undraw_weather.svg)]
<p>
<img alt="PyPI" src="https://img.shields.io/pypi/v/wetter?color=blue">
<img alt="PyPI - License" src="https://img.shields.io/pypi/l/wetter">
<img alt="PyPI - Python Version" src="https://img.shields.io/pypi/pyversions/wetter">
<img alt="PyPI - Format" src="https://img.shields.io/pypi/format/wetter">
<img alt="PyPI - Status" src="https://img.shields.io/pypi/status/wetter">
<img alt="Docker Image Version (tag latest semver)" src="https://img.shields.io/docker/v/ucyo/wetter/latest?color=blue&label=docker">
</p>

---

# Agenda

## 1) Task & Solution
## 2) Project structure & Reasoning
## 3) Difficulties & Possible Improvements

---

<!--

# First ideas

- REST API: First I thought about doing it as a web service, since we talked about REST APIs, deployment strategies, caching and monitoring of services. But after talking with Hannes I decided against it so that it is a local cli tool now. This lead to other decisions.
- Rust Application: Started with a rust application, but moved away from it since serialization and deserialization using `serde` got in the way.
- Python is still the programming language fastest to get a first result.
 -->


# Task

Build a *command-line app* that presents the weather for your *favorite city*.
It shall also be possible to *compare the current weather* of this place to historic data:

- a command to *query the latest data point*
- a command to compare the current weather with an average of the *last week (last 7 days)*, *month* and *year*.
- a command to display the *average temperature for a certain month* (if the data is limited, that is fine) and the *days which were hotter than the average*.

Please ensure your code is *well documented*, *tested* and overall has *high software quality*. The documentation will help us to reproduce your solution while making the review.
---

# Solution

Command-line tool called `wetter-py` available at [GitHub](https://github.com/ucyo/wetter-py).

- Current & historical weather data from [OpenMeteo](https://open-meteo.com/en/docs)
- Historical data is saved as JSON file
- Configuration is saved as TOML file
- Logging options can be set with `WETTER_LOG` environment variable
- Templates for background updates using `cron` and `systemd` are provided
- Installation using GitHub releases or pypi:
  ```bash
  pip install wetter
  ```
- No Installation necessary via Dockerhub:
  ```bash
  docker run -it ucyo/wetter bash
  ```

---
# Solution

Tasks:
- a command to *query the latest data point*
- a command to compare the current weather with an average of the *last week (last 7 days)*, *month* and *year*.
- a command to display the *average temperature for a certain month* (if the data is limited, that is fine) and the *days which were hotter than the average*.

Solution:
- `wetter latest`
- `wetter compare --last-{week,month,year}`
- `wetter compare --month {1,..,12}`
- `wetter update`
- `wetter update --historical`

---

# Project structure

```bash
ucyo@ishimura > tree wetter-py/
.
├── `.github/`
├── `assets/`
├── `cicd-workflows/`
├── `docs/`
├── `wetter/`
├── CHANGELOG.md
├── CONTRIBUTING.md
├── Dockerfile
├── LICENSE
├── Makefile
└── README.md
```
- `.github/`
  - Workflow for building (win, mac, linux) & testing (incl. static)
  - Workflow for creating (pre-)releases i.e. GitHub, PyPi, Docker
- `cicd-workflows/`:
  - Script to build and push (pre-)releases to Dockerhub
- `wetter/`
  - Python project code

---
# Project structure

```bash
ucyo@ishimura > tree wetter-py/wetter/
.
├── `tests/`
├── `wetter/`
├── check.sh
├── poetry.lock
├── pyproject.toml
└── README.md
```
Common python package structure using `pyproject.toml`
for dependency resolution, `tests/` for unit testing, and `README.md` for package description.

---

<!--

```toml
[tool.poetry.dependencies]
python = "^3.8.1"
pandas = "^1.5.3"
requests = "^2.28.2"
platformdirs = "^3.2.0"
toml = "^0.10.2"
numexpr = "^2.8.4"
Bottleneck = "^1.3.7"
``` -->


# Project structure

```bash
ucyo@ishimura > tree wetter-py/wetter/wetter
.
├── `backend/`
│   ├── extern.py
│   ├── local.py
│   └── queries.py
├── `config/`
│   ├── config.py
│   ├── defaults.py
│   └── parser.py
├── app.py
└── tools.py
```
- `app.py`
  - Command-line parsing and pretty printing
- `tools.py`
  - Helper functions for logging, timezones etc.
  - `dt.now()` and `dt.utcnow()` does not include time zone information
- `backend/` and `config/` is explained in more details next

---
# Project structure

```bash
ucyo@ishimura > tree wetter-py/wetter/wetter
.
├── `backend/`
│   ├── extern.py
│   ├── local.py
│   └── queries.py
...
```
- `extern.py`
  - Communication with third party services
  - Interface to external APIs (`APIForWeatherData`)
  - Implementations of interface for OpenMeteo and its archive
  - Interface to queries (`QueryTicket`)
- `local.py`
  - Representation of local measurements (`WetterDB`)
- `queries.py`
  - Data selection of local measurements

---
# Project structure

```bash
ucyo@ishimura > tree wetter-py/wetter/wetter
.
├── `config/`
│   ├── config.py
│   ├── defaults.py
│   └── parser.py
...
```
- `config.py`:
  - Configuration of application e.g. configuration path and data store location
- `defaults.py`:
  - Sane defaults for configuration e.g. config & store data, systemd, systemd_timer, config checks
- `parser.py`
  - Parse config file and data store
  - Datetime objects are not supported by default handler
  - Custom JSON Encoder (`WetterEncoder`)
---
# Reasoning for different choices

+ JSON:
  - Keeping it as simple and maintainable as possible.
  - Considered using a db (postgres or sqlite),
    but measurements are structured and only a couple hundred kilobytes.

```json
{
    "lat": DEFAULT_LAT,
    "lon": DEFAULT_LON,
    "version": 1,
    "data": {
        "index": ["temperature", "wind"],
        "columns": [
            "2023-01-01T00:00:00.000000+0000",
            "2023-01-01T01:00:00.000000+0000",
        ],
        "data": [[7.7, 12.7], [6.8, 13.0]],
    },
}
```

---
# Reasoning for choices
+ Pull Requests for solo development:
  - Opening issues and PR for "big" changes in code.
  - Helps organize information and resources related to changes.
  - Helps with documentation and history tracking.
+ Queries:
  - Separating queries by `QueryTicket` helps checking query parameters in one place.
  - Query specification can be changed later on e.g. more variables, time ranges etc.
  - All query functions have similar syntax input/output.
+ Test folder structure:
  - The test folder has the same file structure as the library.
---
# Difficulty

## Time zones

- I expected this to be a problem. But not to this extend :)
- Caught bug considering the local time zone of the user [here](https://github.com/ucyo/wetter-py/blob/master/wetter/wetter/backend/queries.py#L85-L89)
- Different (sometimes) incompatible libraries e.g. `np.datetime64`, `dt.datetime`.
- Datetime objects are not supported by default handler
- `dt.now()` and `dt.utcnow()` does not include time zone information

---
# Possible Improvements

*Immediate changes*
1. Remove duplicate check file
2. Add Code of Conduct

*Additional features*
<!-- 0. Add more unit tests -->
1. Add interactive update on config change
2. Add minimal docker container
3. Add documentation webpage using Sphinx & enable CI/CD
4. Add `deb` and `rpm` packages
5. Add bash completion
6. Add more weather apis
7. Update CI/CD tasks with more sub-tasks


---
# Possible Improvements <br> (web service)

1. Move config and store to a database
3. Add user authentication
2. Build REST API to query the database
3. Add Ansible deployment configuration
4. Add automated backup routine
5. Add checkmk monitoring service
6. Add cache for inquiries using Redis

    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create({
        ratio: '4:3',
        highlightStyle: 'dracula',
        highlightLines: true,
        highlightSpans: true,
        navigation: {
          scroll: false,
        }
      });
    </script>
  </body>
</html>
